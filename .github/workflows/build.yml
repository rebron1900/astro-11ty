name: Astro-CI

on:
    workflow_dispatch:
    repository_dispatch:
      types:
        - update
    schedule:
      - cron: '0 2 * * *'
jobs:
  build:
    runs-on: ubuntu-latest


    env:
      GHOST_API_URL: $GHOST_API_URL
      GHOST_API_KEY: $GHOST_API_KEY
      GHOST_API_POST_LIMIT: $GHOST_API_POST_LIMIT
      NEODB_URL: $NEODB_URL
      FLUX_URL: $FLUX_URL
      FLUX_KEY: $FLUX_KEY
      CND_URL: $CND_URL
      MAP_URL: $MAP_URL
      MAP_KEY: $MAP_KEY

    steps:
      - name: Install dependencies
        run: env

      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18' 
          cache: 'yarn' 

      - name: Cache Yarn dependencies
        uses: actions/cache@v2
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
          restore-keys: |
            ${{ runner.os }}-yarn-

      - name: Install dependencies
        run: yarn install

      - name: Build Astro project
        run: yarn build

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_PORT: ${{ secrets.VPS_PORT }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PRIVATE_KEY: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "$VPS_SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          echo "StrictHostKeyChecking no" >> ~/.ssh/config
          rsync -avz --delete -e "ssh -p $VPS_PORT" dist/ $VPS_USER@$VPS_HOST:/var/11ty-data